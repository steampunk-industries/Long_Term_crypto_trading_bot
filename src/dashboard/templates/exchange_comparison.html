{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Exchange Price Comparison</h1>

<div class="alert alert-primary mb-4">
    <div class="d-flex align-items-center">
        <div class="me-3">
            <i class="fas fa-sync-alt fa-2x"></i>
        </div>
        <div>
            <h5 class="mb-1">Real-Time Prices</h5>
            <p class="mb-0">
                Comparing cryptocurrency prices across multiple exchanges. Prices update automatically every 30 seconds.
                <button class="btn btn-sm btn-primary ms-2" id="refresh-prices">
                    <i class="fas fa-sync-alt me-1"></i>Refresh Now
                </button>
            </p>
        </div>
    </div>
</div>

<!-- Symbol Selection -->
<div class="card mb-4">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="fas fa-coins me-2"></i>Select Symbol</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label for="symbolSelect">Cryptocurrency</label>
                    <select class="form-control" id="symbolSelect">
                        {% for symbol in symbols %}
                            <option value="{{ symbol }}" {% if symbol == 'BTC/USDT' %}selected{% endif %}>{{ symbol }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group mb-3">
                    <label for="autoRefresh">Auto Refresh</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">Update prices every 30 seconds</label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Price Comparison Table -->
<div class="card mb-4">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Price Comparison</h5>
        <span class="small text-muted" id="lastUpdated">Last updated: Never</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="priceTable">
                <thead>
                    <tr>
                        <th>Exchange</th>
                        <th>Last Price</th>
                        <th>Bid</th>
                        <th>Ask</th>
                        <th>Spread</th>
                        <th>24h Volume</th>
                        <th>24h Change</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="priceTableBody">
                    <tr>
                        <td colspan="8" class="text-center">Loading prices...</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <td><strong>Average</strong></td>
                        <td id="avgPrice">-</td>
                        <td id="avgBid">-</td>
                        <td id="avgAsk">-</td>
                        <td id="avgSpread">-</td>
                        <td id="totalVolume">-</td>
                        <td id="avgChange">-</td>
                        <td>-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Price Arbitrage Opportunities -->
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Arbitrage Opportunities</h5>
    </div>
    <div class="card-body">
        <div id="arbitrageContainer">
            <p class="text-center">
                <i class="fas fa-spin fa-spinner me-2"></i>Calculating arbitrage opportunities...
            </p>
        </div>
    </div>
</div>

<!-- Historical Price Chart -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Price Comparison Chart</h5>
    </div>
    <div class="card-body">
        <div id="priceChart" style="height: 400px;">
            <!-- Chart will be rendered here -->
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const symbolSelect = document.getElementById('symbolSelect');
    const refreshButton = document.getElementById('refresh-prices');
    const autoRefreshToggle = document.getElementById('autoRefresh');
    const lastUpdatedSpan = document.getElementById('lastUpdated');
    const priceTableBody = document.getElementById('priceTableBody');
    const arbitrageContainer = document.getElementById('arbitrageContainer');
    
    let priceChart = null;
    let refreshInterval = null;
    let priceData = {};
    
    // Initialize the price chart
    function initializeChart() {
        const ctx = document.getElementById('priceChart').getContext('2d');
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }
    
    // Fetch price data from the API
    function fetchPrices() {
        const symbol = symbolSelect.value;
        
        // Show loading state
        priceTableBody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-spin fa-spinner me-2"></i>Loading latest prices...</td></tr>';
        
        fetch(`/api/price-comparison/${symbol}`)
            .then(response => response.json())
            .then(data => {
                priceData = data;
                updatePriceTable(data);
                updateArbitrageOpportunities(data);
                updatePriceChart(data);
                
                // Update last updated timestamp
                const now = new Date();
                lastUpdatedSpan.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            })
            .catch(error => {
                console.error('Error fetching price data:', error);
                priceTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading price data. Please try again.</td></tr>';
            });
    }
    
    // Update the price comparison table
    function updatePriceTable(data) {
        let tableContent = '';
        let totalLast = 0;
        let totalBid = 0;
        let totalAsk = 0;
        let totalVolume = 0;
        let totalChange = 0;
        let validExchanges = 0;
        
        for (const [exchange, priceInfo] of Object.entries(data)) {
            if (priceInfo && priceInfo.last) {
                const last = priceInfo.last;
                const bid = priceInfo.bid || 0;
                const ask = priceInfo.ask || 0;
                const spread = ask > 0 && bid > 0 ? ((ask - bid) / ask * 100).toFixed(2) + '%' : '-';
                const volume = priceInfo.volume || 0;
                const change = priceInfo.change_24h || 0;
                
                // Add to totals for average calculation
                totalLast += last;
                if (bid > 0) totalBid += bid;
                if (ask > 0) totalAsk += ask;
                totalVolume += volume;
                if (change !== 0) totalChange += change;
                validExchanges++;
                
                // Best price indicators
                const isBestBid = priceInfo.is_best_bid ? 'text-success fw-bold' : '';
                const isBestAsk = priceInfo.is_best_ask ? 'text-success fw-bold' : '';
                
                tableContent += `
                <tr>
                    <td>${exchange}</td>
                    <td>$${last.toFixed(2)}</td>
                    <td class="${isBestBid}">$${bid.toFixed(2)}</td>
                    <td class="${isBestAsk}">$${ask.toFixed(2)}</td>
                    <td>${spread}</td>
                    <td>${volume.toFixed(2)}</td>
                    <td class="${change >= 0 ? 'text-success' : 'text-danger'}">
                        ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
                    </td>
                    <td><span class="badge bg-success">Online</span></td>
                </tr>
                `;
            }
        }
        
        if (validExchanges === 0) {
            priceTableBody.innerHTML = '<tr><td colspan="8" class="text-center">No price data available</td></tr>';
            return;
        }
        
        // Update table body
        priceTableBody.innerHTML = tableContent;
        
        // Update averages in footer
        document.getElementById('avgPrice').textContent = '$' + (totalLast / validExchanges).toFixed(2);
        document.getElementById('avgBid').textContent = '$' + (totalBid / validExchanges).toFixed(2);
        document.getElementById('avgAsk').textContent = '$' + (totalAsk / validExchanges).toFixed(2);
        document.getElementById('avgSpread').textContent = '-';
        document.getElementById('totalVolume').textContent = totalVolume.toFixed(2);
        document.getElementById('avgChange').textContent = (totalChange / validExchanges).toFixed(2) + '%';
    }
    
    // Update arbitrage opportunities section
    function updateArbitrageOpportunities(data) {
        let opportunities = [];
        const exchanges = Object.keys(data);
        
        // Find opportunities where you can buy on one exchange and sell on another
        for (let i = 0; i < exchanges.length; i++) {
            for (let j = 0; j < exchanges.length; j++) {
                if (i !== j) {
                    const buyExchange = exchanges[i];
                    const sellExchange = exchanges[j];
                    
                    const buyInfo = data[buyExchange];
                    const sellInfo = data[sellExchange];
                    
                    if (buyInfo && sellInfo && buyInfo.ask && sellInfo.bid) {
                        const buyPrice = buyInfo.ask;
                        const sellPrice = sellInfo.bid;
                        
                        const priceDiff = sellPrice - buyPrice;
                        const profitPercentage = (priceDiff / buyPrice) * 100;
                        
                        // Only show opportunities with positive profit
                        if (profitPercentage > 0.5) {
                            opportunities.push({
                                buyExchange,
                                sellExchange,
                                buyPrice,
                                sellPrice,
                                profitPercentage
                            });
                        }
                    }
                }
            }
        }
        
        // Sort opportunities by profit percentage
        opportunities.sort((a, b) => b.profitPercentage - a.profitPercentage);
        
        // Generate HTML for opportunities
        let html = '';
        if (opportunities.length > 0) {
            html = '<div class="row">';
            for (let i = 0; i < Math.min(3, opportunities.length); i++) {
                const opp = opportunities[i];
                html += `
                <div class="col-md-4 mb-3">
                    <div class="card h-100 border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Opportunity #${i+1}</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Buy on:</strong> ${opp.buyExchange} @ $${opp.buyPrice.toFixed(2)}</p>
                            <p><strong>Sell on:</strong> ${opp.sellExchange} @ $${opp.sellPrice.toFixed(2)}</p>
                            <p><strong>Price Difference:</strong> $${(opp.sellPrice - opp.buyPrice).toFixed(2)}</p>
                            <div class="text-center">
                                <h4 class="text-success">${opp.profitPercentage.toFixed(2)}% Profit</h4>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }
            html += '</div>';
        } else {
            html = '<div class="alert alert-info">No significant arbitrage opportunities found at this time.</div>';
        }
        
        arbitrageContainer.innerHTML = html;
    }
    
    // Update the price chart
    function updatePriceChart(data) {
        if (!priceChart) {
            initializeChart();
        }
        
        const exchanges = Object.keys(data);
        const datasets = [];
        
        // Create a dataset for each exchange
        const colors = [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(255, 206, 86)',
            'rgb(75, 192, 192)',
            'rgb(153, 102, 255)'
        ];
        
        exchanges.forEach((exchange, index) => {
            const priceInfo = data[exchange];
            if (priceInfo && priceInfo.last) {
                datasets.push({
                    label: exchange,
                    data: [priceInfo.last],
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '33',
                    tension: 0.1
                });
            }
        });
        
        // If we already have data, append the new prices
        if (priceChart.data.labels.length > 0) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            // Add new label
            priceChart.data.labels.push(timeLabel);
            
            // Keep only the last 10 data points
            if (priceChart.data.labels.length > 10) {
                priceChart.data.labels.shift();
            }
            
            // Update each dataset
            datasets.forEach((newDataset, i) => {
                // Find matching dataset
                const existingDataset = priceChart.data.datasets.find(ds => ds.label === newDataset.label);
                
                if (existingDataset) {
                    existingDataset.data.push(newDataset.data[0]);
                    
                    // Keep only the last 10 data points
                    if (existingDataset.data.length > 10) {
                        existingDataset.data.shift();
                    }
                } else {
                    // If this is a new exchange, add it with empty data for past points
                    const emptyData = Array(priceChart.data.labels.length - 1).fill(null);
                    newDataset.data = [...emptyData, newDataset.data[0]];
                    priceChart.data.datasets.push(newDataset);
                }
            });
            
            // Remove datasets that no longer have data
            priceChart.data.datasets = priceChart.data.datasets.filter(ds => 
                datasets.some(newDs => newDs.label === ds.label)
            );
        } else {
            // Initial data
            const now = new Date();
            priceChart.data.labels = [now.toLocaleTimeString()];
            priceChart.data.datasets = datasets;
        }
        
        priceChart.update();
    }
    
    // Set up event listeners
    symbolSelect.addEventListener('change', fetchPrices);
    refreshButton.addEventListener('click', fetchPrices);
    
    autoRefreshToggle.addEventListener('change', function() {
        if (this.checked) {
            refreshInterval = setInterval(fetchPrices, 30000); // 30 seconds
        } else {
            clearInterval(refreshInterval);
        }
    });
    
    // Initial price fetch
    fetchPrices();
    
    // Set up auto-refresh
    if (autoRefreshToggle.checked) {
        refreshInterval = setInterval(fetchPrices, 30000); // 30 seconds
    }
});
</script>
{% endblock %}
